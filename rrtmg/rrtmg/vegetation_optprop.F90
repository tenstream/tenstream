module m_vegetation_optprop

  use m_data_parameters, only : &
    & init_mpi_data_parameters, &
    & iintegers, ireals, mpiint, &
    & default_str_len

  use m_helper_functions, only: &
    & CHKERR, &
    & toStr, &
    & imp_bcast, &
    & linspace, &
    & get_arg, &
    & split

  use m_tenstream_interpolation, only: interp_1d

  use m_search, only: find_real_location

  implicit none

  type veg_type
    character(len=default_str_len) :: vname
    real(ireals), allocatable :: lambda(:) ! wavelength of sample pts in [m]
    real(ireals), allocatable :: albedo(:) ! albedo at lambda sample point
  end type

  type(veg_type), allocatable :: veg(:)

contains
  subroutine init_vegetation_types_from_usgs(comm, ierr, veg_database_file)
    integer(mpiint), intent(in) :: comm
    integer(mpiint), intent(out) :: ierr
    character(len=*), intent(in), optional :: veg_database_file
    character(len=default_str_len) :: db
    integer(mpiint) :: myid
    ierr=0

    if(allocated(veg)) return

    call mpi_comm_rank(comm, myid, ierr); call CHKERR(ierr)

    if(myid.eq.0) then
      db = get_arg("usgs_material_albedi.txt", veg_database_file)
      call read_usgs_db_file(db, veg, ierr, lverbose=.True.); call CHKERR(ierr)
    endif

    call bcast_veg_struct(comm, veg, ierr); call CHKERR(ierr)
  end subroutine

  subroutine init_vegetation_types_simple(comm, ierr)
    integer(mpiint), intent(in) :: comm
    integer(mpiint), intent(out) :: ierr
    integer(mpiint) :: myid
    ierr=0

    if(allocated(veg)) return

    call mpi_comm_rank(comm, myid, ierr); call CHKERR(ierr)

    allocate(veg(3))

    veg(1)%vname = "bark" ! from usgs WhitebarkPine YNP-WB-1 frst AVIRISb RTGC
    veg(1)%lambda = [real(ireals) :: &
      & 0.419,0.429,0.449,0.458,0.468,0.478,0.488,0.498,0.508,0.517,0.527,0.537,0.547,0.557,0.567,0.577,0.586,0.606,0.616,0.626,&
      & 0.636,0.646,0.656,0.665,0.676,0.685,0.695,0.704,0.714,0.733,0.743,0.752,0.772,0.781,0.8,0.819,0.829,0.848,0.858,0.877,&
      & 0.887,0.896,0.906,0.915,0.954,0.964,0.973,0.983,0.992,1.002,1.031,1.04,1.06,1.069,1.088,1.108,1.117,1.165,1.175,1.185,&
      & 1.194,1.204,1.214,1.233,1.252,1.264,1.274,1.284,1.294,1.304,1.314,1.324,1.334,1.424,1.434,1.444,1.454,1.464,1.473,1.483,&
      & 1.493,1.503,1.513,1.523,1.553,1.563,1.573,1.583,1.593,1.603,1.613,1.633,1.643,1.663,1.673,1.683,1.692,1.712,1.722,1.742,&
      & 1.752,1.762,1.772,1.782,1.792,1.802,1.812,1.949,1.959,1.97,1.98,1.99,2.03,2.04,2.05,2.06,2.07,2.08,2.09,2.1,&
      & 2.11,2.12,2.14,2.15,2.16,2.17,2.18,2.2,2.21,2.229,2.239,2.249,2.259,2.269,2.279,2.289,2.299,2.309,2.319,2.329,&
      & 2.339,2.349,2.359,2.369,2.379,2.389,2.399,2.408,2.418,2.428,2.438,2.448,2.458,2.468,2.478] * 1e-6_ireals

    veg(1)%albedo = [real(ireals) :: &
      & 0.013,0.015,0.017,0.017,0.017,0.017,0.017,0.017,0.018,0.021,0.024,0.027,0.029,0.03,0.03,0.028,0.027,0.027,0.026,0.026,&
      & 0.026,0.025,0.024,0.023,0.023,0.025,0.033,0.046,0.062,0.099,0.113,0.121,0.128,0.129,0.132,0.135,0.136,0.139,0.141,0.143,&
      & 0.144,0.144,0.143,0.144,0.138,0.137,0.137,0.137,0.139,0.14,0.149,0.152,0.156,0.158,0.159,0.156,0.151,0.131,0.129,0.128,&
      & 0.127,0.128,0.13,0.137,0.143,0.146,0.147,0.146,0.145,0.142,0.137,0.131,0.122,0.057,0.056,0.054,0.054,0.053,0.055,0.056,&
      & 0.059,0.061,0.064,0.067,0.074,0.076,0.078,0.08,0.081,0.084,0.086,0.089,0.09,0.091,0.09,0.089,0.088,0.085,0.084,0.083,&
      & 0.082,0.08,0.08,0.079,0.079,0.079,0.078,0.045,0.043,0.042,0.042,0.043,0.048,0.047,0.047,0.047,0.047,0.047,0.047,0.047,&
      & 0.048,0.049,0.049,0.05,0.051,0.052,0.053,0.055,0.056,0.055,0.053,0.052,0.05,0.047,0.046,0.046,0.043,0.042,0.041,0.042,&
      & 0.041,0.039,0.04,0.04,0.039,0.038,0.036,0.037,0.034,0.035,0.034,0.032,0.031,0.034,0.033]

    veg(2)%vname = "grass" ! from usgs LawnGrass GDS91b shifted 3nm  BECKa AREF
    veg(2)%lambda = [real(ireals) :: &
      & 0.205,0.301,0.309,0.313,0.321,0.325,0.329,0.333,0.337,0.341,0.345,0.349,0.353,0.357,0.361,0.364,0.367,0.37,0.373,0.376,&
      & 0.379,0.381,0.383,0.385,0.387,0.389,0.393,0.395,0.416,0.419,0.422,0.425,0.428,0.431,0.434,0.437,0.44,0.443,0.446,0.449,&
      & 0.451,0.457,0.463,0.467,0.469,0.471,0.473,0.481,0.483,0.487,0.491,0.497,0.501,0.505,0.507,0.509,0.513,0.515,0.517,0.519,&
      & 0.523,0.525,0.527,0.529,0.531,0.535,0.537,0.543,0.545,0.547,0.553,0.555,0.557,0.559,0.561,0.563,0.565,0.567,0.569,0.573,&
      & 0.575,0.577,0.581,0.583,0.585,0.587,0.589,0.591,0.593,0.595,0.597,0.599,0.601,0.603,0.606,0.608,0.609,0.611,0.614,0.617,&
      & 0.619,0.62,0.622,0.624,0.625,0.627,0.628,0.63,0.632,0.636,0.638,0.64,0.642,0.646,0.65,0.652,0.656,0.658,0.66,0.662,&
      & 0.666,0.668,0.67,0.673,0.676,0.682,0.685,0.688,0.691,0.694,0.697,0.7,0.702,0.704,0.706,0.708,0.71,0.712,0.714,0.716,&
      & 0.718,0.72,0.722,0.724,0.726,0.728,0.73,0.732,0.734,0.736,0.738,0.74,0.742,0.744,0.746,0.748,0.751,0.754,0.757,0.76,&
      & 0.762,0.766,0.769,0.771,0.775,0.778,0.781,0.785,0.789,0.793,0.802,0.812,0.817,0.822,0.828,0.835,0.843,0.851,0.859,0.871,&
      & 0.883,0.894,0.904,0.914,0.924,0.933,0.941,0.949,0.957,0.964,0.97,0.976,0.988,0.994,1.0,1.006,1.012,1.018,1.024,1.028,&
      & 1.034,1.038,1.043,1.048,1.053,1.058,1.063,1.068,1.078,1.084,1.088,1.094,1.098,1.104,1.114,1.118,1.124,1.128,1.134,1.138,&
      & 1.144,1.148,1.154,1.158,1.164,1.168,1.174,1.179,1.188,1.194,1.204,1.208,1.214,1.228,1.234,1.248,1.254,1.258,1.268,1.274,&
      & 1.279,1.289,1.294,1.299,1.303,1.308,1.313,1.318,1.323,1.343,1.348,1.353,1.358,1.363,1.368,1.374,1.378,1.384,1.388,1.394,&
      & 1.398,1.404,1.408,1.414,1.418,1.423,1.428,1.433,1.438,1.443,1.448,1.453,1.458,1.463,1.468,1.478,1.484,1.494,1.498,1.504,&
      & 1.508,1.514,1.518,1.524,1.528,1.534,1.54,1.546,1.552,1.558,1.564,1.57,1.578,1.584,1.592,1.598,1.606,1.612,1.619,1.634,&
      & 1.64,1.647,1.654,1.662,1.668,1.676,1.684,1.692,1.7,1.708,1.716,1.724,1.732,1.74,1.748,1.764,1.772,1.78,1.788,1.796,&
      & 1.815,1.825,1.835,1.845,1.855,1.865,1.875,1.885,1.895,1.905,1.915,1.925,1.935,1.945,1.955,1.965,1.975,1.985,1.995,2.005,&
      & 2.015,2.025,2.035,2.045,2.055,2.065,2.075,2.085,2.095,2.105,2.115,2.125,2.135,2.145,2.155,2.165,2.175,2.185,2.195,2.205,&
      & 2.215,2.225,2.235,2.245,2.255,2.265,2.275,2.285,2.295,2.305,2.315,2.325,2.335,2.345,2.355,2.365,2.375,2.386,2.4,2.418,&
      & 2.44,2.466,2.496,2.528,2.56,2.592,2.624,2.656,2.688,2.72,2.752,2.784,2.816,2.88,2.912,2.944,2.976] * 1e-6_ireals
    veg(2)%albedo = [real(ireals) :: &
      0.02,0.02,0.019,0.02,0.02,0.02,0.019,0.024,0.025,0.021,0.02,0.023,0.025,0.024,0.024,0.025,0.024,0.022,0.02,0.024,&
      & 0.02,0.021,0.021,0.022,0.022,0.023,0.024,0.025,0.03,0.03,0.03,0.031,0.031,0.031,0.032,0.031,0.032,0.032,0.035,0.036,&
      & 0.036,0.036,0.036,0.037,0.036,0.036,0.037,0.037,0.037,0.037,0.038,0.04,0.042,0.045,0.047,0.05,0.056,0.06,0.064,0.069,&
      & 0.077,0.081,0.085,0.088,0.09,0.093,0.094,0.095,0.097,0.097,0.097,0.095,0.095,0.094,0.092,0.089,0.087,0.084,0.08,0.075,&
      & 0.073,0.072,0.067,0.067,0.068,0.065,0.064,0.064,0.063,0.063,0.063,0.062,0.063,0.062,0.061,0.059,0.059,0.059,0.056,0.056,&
      & 0.054,0.054,0.054,0.053,0.054,0.053,0.053,0.053,0.053,0.051,0.05,0.048,0.048,0.045,0.044,0.044,0.043,0.042,0.041,0.041,&
      & 0.039,0.039,0.038,0.039,0.038,0.04,0.042,0.049,0.059,0.072,0.091,0.113,0.127,0.14,0.155,0.172,0.189,0.206,0.224,0.244,&
      & 0.265,0.287,0.31,0.334,0.359,0.385,0.411,0.436,0.462,0.485,0.508,0.531,0.553,0.571,0.588,0.605,0.62,0.637,0.651,0.66,&
      & 0.668,0.674,0.678,0.683,0.686,0.687,0.69,0.692,0.693,0.695,0.699,0.701,0.704,0.704,0.703,0.704,0.708,0.707,0.704,0.704,&
      & 0.703,0.706,0.705,0.704,0.7,0.695,0.687,0.674,0.663,0.659,0.657,0.659,0.66,0.664,0.668,0.67,0.676,0.68,0.682,0.687,&
      & 0.69,0.693,0.695,0.695,0.697,0.699,0.699,0.699,0.7,0.698,0.698,0.698,0.694,0.693,0.689,0.686,0.681,0.671,0.656,0.638,&
      & 0.619,0.603,0.593,0.586,0.582,0.579,0.576,0.574,0.573,0.572,0.572,0.573,0.576,0.582,0.584,0.591,0.593,0.594,0.594,0.592,&
      & 0.591,0.585,0.581,0.575,0.568,0.559,0.548,0.537,0.524,0.47,0.46,0.452,0.441,0.429,0.414,0.395,0.366,0.33,0.292,0.255,&
      & 0.224,0.197,0.181,0.169,0.16,0.154,0.15,0.147,0.143,0.141,0.142,0.142,0.144,0.145,0.148,0.158,0.164,0.177,0.182,0.189,&
      & 0.196,0.204,0.212,0.22,0.228,0.235,0.243,0.252,0.26,0.267,0.274,0.282,0.289,0.297,0.304,0.311,0.316,0.323,0.329,0.336,&
      & 0.339,0.342,0.345,0.347,0.347,0.344,0.342,0.34,0.337,0.333,0.327,0.321,0.315,0.312,0.303,0.29,0.285,0.284,0.283,0.282,&
      & 0.283,0.282,0.277,0.264,0.242,0.205,0.15,0.1,0.066,0.05,0.043,0.043,0.042,0.042,0.045,0.052,0.055,0.061,0.064,0.072,&
      & 0.079,0.083,0.088,0.094,0.102,0.107,0.114,0.119,0.126,0.134,0.14,0.144,0.146,0.153,0.154,0.159,0.159,0.162,0.165,0.166,&
      & 0.168,0.166,0.164,0.161,0.154,0.155,0.145,0.14,0.131,0.126,0.123,0.117,0.113,0.107,0.103,0.101,0.095,0.089,0.082,0.074,&
      & 0.065,0.054,0.045,0.042,0.044,0.04,0.034,0.029,0.013,0.005,0.003,0.02,0.0,0.009,0.014,0.012,0.003 ]

    veg(3)%vname = "leaf" ! from usgs walnut
    veg(3)%lambda = [real(ireals) :: &
      & 0.301,0.305,0.309,0.313,0.317,0.321,0.325,0.329,0.333,0.337,0.341,0.345,0.349,0.353,0.357,0.361,0.364,0.367,0.37,0.373,&
      & 0.376,0.379,0.381,0.383,0.385,0.387,0.389,0.391,0.393,0.395,0.397,0.399,0.401,0.403,0.405,0.407,0.409,0.411,0.413,0.416,&
      & 0.419,0.422,0.425,0.428,0.431,0.434,0.437,0.44,0.443,0.446,0.449,0.451,0.453,0.455,0.457,0.459,0.461,0.463,0.465,0.467,&
      & 0.469,0.471,0.473,0.475,0.477,0.479,0.481,0.483,0.485,0.487,0.489,0.491,0.493,0.495,0.497,0.499,0.501,0.503,0.505,0.507,&
      & 0.509,0.511,0.513,0.515,0.517,0.519,0.521,0.523,0.525,0.527,0.529,0.531,0.533,0.535,0.537,0.539,0.541,0.543,0.545,0.547,&
      & 0.549,0.551,0.553,0.555,0.557,0.559,0.561,0.563,0.565,0.567,0.569,0.571,0.573,0.575,0.577,0.579,0.581,0.583,0.585,0.587,&
      & 0.589,0.591,0.593,0.595,0.597,0.599,0.601,0.603,0.604,0.606,0.608,0.609,0.611,0.612,0.614,0.616,0.617,0.619,0.62,0.622,&
      & 0.624,0.625,0.627,0.628,0.63,0.632,0.634,0.636,0.638,0.64,0.642,0.644,0.646,0.648,0.65,0.652,0.654,0.656,0.658,0.66,&
      & 0.662,0.664,0.666,0.668,0.67,0.673,0.676,0.679,0.682,0.685,0.688,0.691,0.694,0.697,0.7,0.702,0.704,0.706,0.708,0.71,&
      & 0.712,0.714,0.716,0.718,0.72,0.722,0.724,0.726,0.728,0.73,0.732,0.734,0.736,0.738,0.74,0.742,0.744,0.746,0.748,0.751,&
      & 0.754,0.757,0.76,0.762,0.766,0.769,0.771,0.775,0.778,0.781,0.785,0.789,0.793,0.797,0.802,0.807,0.812,0.817,0.822,0.828,&
      & 0.835,0.843,0.851,0.859,0.871,0.883,0.894,0.904,0.914,0.924,0.933,0.941,0.949,0.957,0.964,0.97,0.976,0.982,0.988,0.994,&
      & 1.0,1.006,1.012,1.018,1.024,1.028,1.034,1.038,1.043,1.048,1.053,1.058,1.063,1.068,1.074,1.078,1.084,1.088,1.094,1.098,&
      & 1.104,1.108,1.114,1.118,1.124,1.128,1.134,1.138,1.144,1.148,1.154,1.158,1.164,1.168,1.174,1.179,1.184,1.188,1.194,1.198,&
      & 1.204,1.208,1.214,1.218,1.224,1.228,1.234,1.238,1.244,1.248,1.254,1.258,1.264,1.268,1.274,1.279,1.284,1.289,1.294,1.299,&
      & 1.303,1.308,1.313,1.318,1.323,1.328,1.333,1.338,1.343,1.348,1.353,1.358,1.363,1.368,1.374,1.378,1.384,1.388,1.394,1.398,&
      & 1.404,1.408,1.414,1.418,1.423,1.428,1.433,1.438,1.443,1.448,1.453,1.458,1.463,1.468,1.474,1.478,1.484,1.488,1.494,1.498,&
      & 1.504,1.508,1.514,1.518,1.524,1.528,1.534,1.54,1.546,1.552,1.558,1.564,1.57,1.578,1.584,1.592,1.598,1.606,1.612,1.619,&
      & 1.626,1.634,1.64,1.647,1.654,1.662,1.668,1.676,1.684,1.692,1.7,1.708,1.716,1.724,1.732,1.74,1.748,1.756,1.764,1.772,&
      & 1.78,1.788,1.796,1.805,1.815,1.825,1.835,1.845,1.855,1.865,1.875,1.885,1.895,1.905,1.915,1.925,1.935,1.945,1.955,1.965,&
      & 1.975,1.985,1.995,2.005,2.015,2.025,2.035,2.045,2.055,2.065,2.075,2.085,2.095,2.105,2.115,2.125,2.135,2.145,2.155,2.165,&
      & 2.175,2.185,2.195,2.205,2.215,2.225,2.235,2.245,2.255,2.265,2.275,2.285,2.295,2.305,2.315,2.325,2.335,2.345,2.355,2.365,&
      & 2.375,2.386,2.4,2.418,2.44,2.466,2.496,2.528,2.56,2.592,2.624,2.656,2.688 ] * 1e-6_ireals
    veg(3)%albedo = [real(ireals) :: &
      & 0.042,0.042,0.042,0.041,0.042,0.042,0.042,0.042,0.042,0.042,0.042,0.042,0.042,0.042,0.042,0.043,0.042,0.042,0.043,0.042,&
      & 0.042,0.043,0.043,0.043,0.043,0.043,0.043,0.043,0.043,0.043,0.043,0.043,0.044,0.043,0.044,0.044,0.044,0.044,0.045,0.045,&
      & 0.046,0.047,0.048,0.05,0.051,0.053,0.054,0.056,0.058,0.059,0.06,0.061,0.062,0.063,0.063,0.063,0.064,0.064,0.065,0.065,&
      & 0.065,0.065,0.066,0.066,0.066,0.066,0.066,0.065,0.066,0.066,0.067,0.067,0.069,0.069,0.071,0.072,0.074,0.075,0.078,0.08,&
      & 0.083,0.086,0.091,0.095,0.1,0.106,0.112,0.119,0.125,0.131,0.136,0.141,0.145,0.148,0.152,0.154,0.156,0.157,0.159,0.16,&
      & 0.161,0.163,0.163,0.163,0.163,0.161,0.16,0.158,0.156,0.154,0.151,0.147,0.143,0.14,0.137,0.133,0.131,0.129,0.127,0.125,&
      & 0.124,0.123,0.122,0.122,0.121,0.121,0.121,0.12,0.119,0.118,0.117,0.115,0.113,0.111,0.11,0.108,0.106,0.105,0.104,0.103,&
      & 0.102,0.102,0.101,0.102,0.101,0.101,0.101,0.1,0.1,0.099,0.097,0.096,0.095,0.093,0.091,0.089,0.088,0.086,0.084,0.082,&
      & 0.08,0.078,0.075,0.074,0.073,0.071,0.07,0.07,0.071,0.073,0.078,0.088,0.103,0.126,0.155,0.174,0.195,0.216,0.236,0.257,&
      & 0.277,0.298,0.319,0.338,0.357,0.377,0.395,0.411,0.426,0.44,0.454,0.464,0.475,0.483,0.491,0.497,0.503,0.507,0.511,0.515,&
      & 0.519,0.521,0.524,0.526,0.527,0.528,0.529,0.53,0.53,0.531,0.532,0.532,0.533,0.533,0.533,0.534,0.534,0.534,0.534,0.535,&
      & 0.535,0.536,0.537,0.537,0.537,0.537,0.538,0.538,0.536,0.537,0.537,0.535,0.532,0.529,0.529,0.528,0.528,0.527,0.527,0.528,&
      & 0.528,0.529,0.529,0.529,0.532,0.532,0.533,0.533,0.535,0.535,0.534,0.535,0.535,0.536,0.535,0.535,0.535,0.535,0.534,0.535,&
      & 0.533,0.534,0.532,0.532,0.531,0.529,0.527,0.522,0.517,0.512,0.508,0.503,0.5,0.498,0.496,0.495,0.493,0.494,0.493,0.491,&
      & 0.49,0.491,0.492,0.494,0.495,0.497,0.498,0.5,0.501,0.502,0.502,0.502,0.502,0.503,0.503,0.503,0.502,0.501,0.499,0.498,&
      & 0.496,0.494,0.49,0.486,0.482,0.477,0.471,0.465,0.459,0.454,0.449,0.444,0.438,0.432,0.423,0.409,0.391,0.365,0.336,0.304,&
      & 0.275,0.25,0.231,0.217,0.207,0.2,0.195,0.191,0.189,0.187,0.186,0.186,0.187,0.19,0.194,0.199,0.205,0.211,0.217,0.224,&
      & 0.231,0.238,0.245,0.253,0.259,0.267,0.272,0.28,0.286,0.294,0.3,0.306,0.311,0.317,0.323,0.328,0.333,0.338,0.342,0.345,&
      & 0.348,0.351,0.353,0.355,0.356,0.355,0.355,0.352,0.349,0.343,0.335,0.328,0.319,0.318,0.318,0.318,0.315,0.31,0.307,0.303,&
      & 0.302,0.307,0.307,0.309,0.31,0.311,0.311,0.305,0.292,0.264,0.218,0.158,0.105,0.079,0.068,0.065,0.064,0.065,0.068,0.072,&
      & 0.077,0.082,0.089,0.094,0.102,0.108,0.116,0.12,0.125,0.132,0.137,0.143,0.149,0.154,0.159,0.166,0.17,0.174,0.176,0.178,&
      & 0.182,0.185,0.188,0.191,0.194,0.196,0.193,0.187,0.178,0.168,0.158,0.151,0.141,0.135,0.132,0.129,0.126,0.122,0.118,0.114,&
      & 0.114,0.11,0.105,0.096,0.088,0.078,0.07,0.066,0.067,0.066,0.063,0.054,0.043 ]
  end subroutine

  subroutine bcast_veg_struct(comm, veg, ierr)
    integer(mpiint), intent(in) :: comm
    type(veg_type), intent(inout), allocatable :: veg(:)
    integer(mpiint), intent(out) :: ierr

    integer(mpiint) :: myid
    integer(iintegers) :: Nmat, i

    ierr = 0

    call mpi_comm_rank(comm, myid, ierr); call CHKERR(ierr)

    if(myid.eq.0) then
      if(.not. allocated(veg)) call CHKERR(1_mpiint, 'I expected that rank 0 has database allocated but it isnt')
      Nmat = size(veg)
    endif
    call imp_bcast(comm, Nmat, ierr); call CHKERR(ierr)
    if(.not.allocated(veg)) then
      allocate(veg(Nmat))
    endif

    do i=1,Nmat
      call imp_bcast(comm, veg(i)%vname, ierr); call CHKERR(ierr)
      call imp_bcast(comm, veg(i)%lambda, ierr); call CHKERR(ierr)
      call imp_bcast(comm, veg(i)%albedo, ierr); call CHKERR(ierr)
    enddo
  end subroutine

  subroutine read_usgs_db_file(db, veg, ierr, lverbose)
    character(len=*), intent(in) :: db
    type(veg_type), intent(out), allocatable :: veg(:)
    integer(mpiint), intent(out) :: ierr
    logical, intent(in), optional :: lverbose

    integer :: funit, io
    logical :: file_exists, verbose
    integer(iintegers) :: nlines, Nmat, i
    character(len=2**14) :: line_str
    !real(ireals), allocatable :: line(:)

    verbose = get_arg(.False., lverbose)
    ierr=0
    inquire(file=db, exist=file_exists)
    if(.not.file_exists) then
      ierr = 1
      call CHKERR(ierr, 'File '//trim(db)//' does not exist!')
    endif

    open(newunit=funit, file=db)
    read(funit,*) ! skip first line

    ! first count no of lines
    nlines = 0
    do
      read(funit, *, iostat=io)
      if (io.lt.0) exit ! end of file
      nlines = nlines + 1
    end do
    Nmat = nlines / 3
    if(verbose) print *, 'Found '//toStr(nlines)//' in usgs database, i.e. '//toStr(Nmat)//' materials.'
    call CHKERR(modulo(Nmat,3), 'lines in usgs database has to be divideable by 3')

    ! go through it a second time and allocate space
    rewind(funit)
    read(funit,*) ! skip first line

    allocate(veg(Nmat))

    do i = 1, Nmat
      read(funit, '(A)') veg(i)%vname

      read(funit, '(A)', iostat=io) line_str
      call split(line_str, veg(i)%lambda, ' ', ierr); call CHKERR(ierr)

      read(funit, '(A)', iostat=io) line_str
      call split(line_str, veg(i)%albedo, ' ', ierr); call CHKERR(ierr)

      if(verbose) print *,'Add '//trim(veg(i)%vname)//' to materials database'
    enddo

    close(funit)
  end subroutine

  function get_veg_type_id(vegname) result(id)
    character(len=*), intent(in) :: vegname
    integer(iintegers) :: id
    do id = 1, size(veg)
      if (trim(veg(id)%vname) == trim(vegname)) return
    enddo
    call CHKERR(-1_mpiint, 'could not find veg type for veg_name ('//vegname//')')
  end function

  function get_albedo_for_range(veg_id, lambda_min, lambda_max) result(albedo)
    integer(iintegers), intent(in) :: veg_id
    real(ireals), intent(in) :: lambda_min, lambda_max
    real(ireals) :: albedo, albedo1, albedo2

    integer(iintegers) :: Nsample, i
    real(ireals) :: lstart, lend, lambda

    if(lambda_min.gt.lambda_max) &
      & call CHKERR(1_mpiint, 'lambda start has to be smaller than lambda max')
    if(veg_id.lt.1 .or. veg_id.gt.size(veg)) &
      & call CHKERR(1_mpiint, 'bad veg_id ('//toStr(veg_id)//')')
    lstart = find_real_location(veg(veg_id)%lambda, lambda_min)
    lend   = find_real_location(veg(veg_id)%lambda, lambda_max)
    ! ok so we have to integrate over wavelength from [lstart to lend]
    ! which could hold a couple of spectral albedo sample points.
    ! We could try to integrate it thoroughly here
    ! but this will not give the right results anyway because we convolve it with RT results anyway.
    ! So for now we just sample the wavelength spectra in equidistant steps depending on the number of
    ! sample points that we have in the input data because this is the easiest to code and should be fairly robust.
    Nsample = 1_iintegers + int(ceiling(lend-lstart), iintegers)
    albedo = 0
    do i = 1, Nsample
      lambda = linspace(i, [lstart, lend], Nsample)
      albedo = albedo + interp_1d(lambda, veg(veg_id)%albedo)
    enddo
    albedo = albedo / Nsample
    albedo1 = interp_1d(lstart, veg(veg_id)%albedo)
    albedo2 = interp_1d(lend  , veg(veg_id)%albedo)
  end function
end module
