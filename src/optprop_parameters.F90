!-------------------------------------------------------------------------
! This file is part of the tenstream solver.
!
! This program is free software: you can redistribute it and/or modify
! it under the terms of the GNU General Public License as published by
! the Free Software Foundation, either version 3 of the License, or
! (at your option) any later version.
!
! This program is distributed in the hope that it will be useful,
! but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
! GNU General Public License for more details.
!
! You should have received a copy of the GNU General Public License
! along with this program.  If not, see <http://www.gnu.org/licenses/>.
!
! Copyright (C) 2010-2015  Fabian Jakub, <fabian@jakub.com>
!-------------------------------------------------------------------------

module m_optprop_parameters
  use m_data_parameters, only: irealLUT, iintegers, default_str_len
  implicit none

  !> \page optprop_parameters Parameters concerning the transport coefficients
      !! You probably have to define the location to find the Look
      !! Up Tables for the transport coefficients
      !! e.g. with `-lut_basename <globally_reacheable_path/LUT>
      !! as command line option, in the `tenstream.options` file or in your `$HOME/.petscrc`.
      !!
      !! This module includes more options that the average should not need to be aware of.

  !-----------------------------------------
  !> Define the path to the Lookuptables
      !!
      !!  This has to be a reachable path for rank 0,
      !!  At MIM in Munich please set to
      !!  '/home/opt/cosmo_tica_lib/tenstream/optpropLUT/LUT'
      !!  At ZMAW in Hamburg please set to
      !!  '/scratch/mpi/mpiaes/m300362/tenstream_LUT/LUT'
  !-----------------------------------------

  character(default_str_len) :: lut_basename = './LUT'

  logical, parameter :: luse_memory_map = .true.

  !-----------------------------------------
  !- Define the size of the Lookuptables:  -
  !-----------------------------------------
  !
  integer(iintegers), parameter :: LUT_MAX_DIM = 8

  ! We pre-compute the dimensions for the LUT using eddington coeffs as proxy for good values
  !     -- see python script: ''eddington_to_LUT.py''
  real(irealLUT), parameter :: param_eps = 1e-4
  real, parameter :: peps_r = real(param_eps)

  real(irealLUT), parameter :: preset_param_phi6(6) = &
                               [-2., -1.-peps_r, -1.+peps_r, &
                                +1.-peps_r, +1.+peps_r, 2.]

  real(irealLUT), parameter :: preset_param_phi11(11) = &
                               [-2., -1.5, &
                                -1.-peps_r, -1.+peps_r, &
                                -0.5, 0., 0.5, &
                                +1.-peps_r, +1.+peps_r, &
                                1.5, 2.]

  real(irealLUT), parameter :: preset_param_phi19(19) = [ &
                               -2., -1.75, -1.5, -1.25, &
                               -1.-peps_r, -1.+peps_r, &
                               -0.75, -0.5, -0.25, 0., 0.25, 0.5, 0.75, &
                               +1.-peps_r, +1.+peps_r, &
                               1.25, 1.5, 1.75, 2.]

  real(irealLUT), parameter :: preset_param_phi83(83) = [ &
                               -2., -1.95, -1.9, -1.85, -1.8, -1.75, -1.7, -1.65, -1.6, &
                               -1.55, -1.5, -1.45, -1.4, -1.35, -1.3, -1.25, -1.2, -1.15, &
                               -1.1, -1.05, -1.-peps_r, -1.+peps_r, &
                               -0.95, -0.9, -0.85, -0.8, -0.75, -0.7, &
                               -0.65, -0.6, -0.55, -0.5, -0.45, -0.4, -0.35, -0.3, -0.25, &
                               -0.2, -0.15, -0.1, -0.05, 0., 0.05, 0.1, 0.15, 0.2, &
                               0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, &
                               0.7, 0.75, 0.8, 0.85, 0.9, 0.95, &
                               +1.-peps_r, +1.+peps_r, 1.05, 1.1, &
                               1.15, 1.2, 1.25, 1.3, 1.35, 1.4, 1.45, 1.5, 1.55, &
                               1.6, 1.65, 1.7, 1.75, 1.8, 1.85, 1.9, 1.95, 2.]

  real(irealLUT), parameter :: preset_param_theta4(4) = [ &
                               -1., -peps_r, +peps_r, 1.]

  real(irealLUT), parameter :: preset_param_theta13(13) = [ &
                               -1., -peps_r, +peps_r, &
                               .1, .2, .3, .4, .5, .6, .7, .8, .9, 1.]

  real(irealLUT), parameter :: preset_aspect5(5) = [.2, .5, 1., 2., 5.]
  real(irealLUT), parameter :: preset_aspect7(7) = &
                               [0.03125, 0.0625, 0.125, 0.25, 0.5, 1., 2.]
  real(irealLUT), parameter :: preset_aspect11(11) = [ &
                               0.125, 0.16493849, 0.21763764, 0.28717459, 0.37892914, &
                               0.5, 0.65975396, 0.87055056, 1.14869835, 1.51571657, &
                               2.]
  real(irealLUT), parameter :: preset_aspect13(13) = [ &
                               0.02, 0.042, 0.075, 0.133, 0.237, 0.422, 0.75, 1., 1.25, &
                               1.953, 3.052, 4.768, 7.451]
  real(irealLUT), parameter :: preset_aspect17(17) = [ &
                               0.02, 0.032, 0.042, 0.056, 0.075, 0.1, 0.133, 0.178, 0.237, &
                               0.316, 0.422, 0.562, 0.75, 1., 1.25, 1.562, 2.]
  real(irealLUT), parameter :: preset_aspect18(18) = [ &
                               0.02, 0.032, 0.042, 0.056, 0.075, 0.1, 0.133, 0.178, 0.237, &
                               0.316, 0.422, 0.562, 0.75, 1., 1.25, 1.562, 2., 3.]
  real(irealLUT), parameter :: preset_aspect23(23) = [ &
                               0.02, 0.032, 0.042, 0.056, 0.075, 0.1, 0.133, 0.178, 0.237, &
                               0.316, 0.422, 0.562, 0.75, 1., 1.25, 1.562, 1.953, 2.441, &
                               3.052, 3.815, 4.768, 5.96, 7.451]
  real(irealLUT), parameter :: preset_aspect90(90) = [real(irealLUT) :: & ! hstack((linspace(0.02,1,50), 1. / linspace(0.2,1,41)[::-1][1:]))
                             & 0.02, 0.04, 0.06, 0.08, 0.1, &
                             & 0.12, 0.14, 0.16, 0.18, 0.2, &
                             & 0.22, 0.24, 0.26, 0.28, 0.3, &
                             & 0.32, 0.34, 0.36, 0.38, 0.4, &
                             & 0.42, 0.44, 0.46, 0.48, 0.5, &
                             & 0.52, 0.54, 0.56, 0.58, 0.6, &
                             & 0.62, 0.64, 0.66, 0.68, 0.7, &
                             & 0.72, 0.74, 0.76, 0.78, 0.8, &
                             & 0.82, 0.84, 0.86, 0.88, 0.9, &
                             & 0.92, 0.94, 0.96, 0.98, 1., &
                             & 1.02040816, 1.04166667, 1.06382979, 1.08695652, 1.11111111, &
                             & 1.13636364, 1.1627907, 1.19047619, 1.2195122, 1.25, &
                             & 1.28205128, 1.31578947, 1.35135135, 1.38888889, 1.42857143, &
                             & 1.47058824, 1.51515152, 1.5625, 1.61290323, 1.66666667, &
                             & 1.72413793, 1.78571429, 1.85185185, 1.92307692, 2., &
                             & 2.08333333, 2.17391304, 2.27272727, 2.38095238, 2.5, &
                             & 2.63157895, 2.77777778, 2.94117647, 3.125, 3.33333333, &
                             & 3.57142857, 3.84615385, 4.16666667, 4.54545455, 5.]

  real(irealLUT), parameter :: preset_tau15(15) = &
                               [1e-10, 9.60528972228e-06, 0.00023849409901, 0.00166198651975, &
                                0.00673267911551, 0.0202911873538, 0.051171357661, 0.116239684, &
                                0.258968664233, 0.568687940597, 1.2527762873, 2.64735111809, &
                                5.53090672088, 14.5233716971, 100.0]

  real(irealLUT), parameter :: preset_tau20(20) = &
                               [1e-10, 2.33773213401e-06, 5.40185638224e-05, 0.000365962943669, &
                                0.00145415861897, 0.00431514105527, 0.0105306225135, &
                                0.0225104907999, 0.044534085216, 0.0835690735283, &
                                0.152160041198, 0.271322429414, 0.492503225042, &
                                0.91860742252, 1.60959133986, 2.79337830498, 4.89077663742, &
                                9.35922562367, 21.643468069, 100.0]

  real(irealLUT), parameter :: preset_tau31(31) = &
                               [1e-10, 3.62266272998e-07, 7.04565803675e-06, 4.47545500233e-05, &
                                0.000172126759821, 0.000495994753047, 0.00119161313679, &
                                0.00251026980343, 0.00480799264297, 0.00856221891924, &
                                0.0143961482731, 0.0231530284254, 0.0358868239775, &
                                0.0541358315379, 0.079959118223, 0.11623968405, 0.167882053841, &
                                0.246414427244, 0.350199325489, 0.502459974196, 0.759082408765, &
                                1.08083180518, 1.5415157991, 2.19832932733, 3.04549626819, &
                                4.27145477454, 6.16953841432, 9.43719309835, 15.7335501106, &
                                29.5819342206, 100.0]

  real(irealLUT), parameter :: preset_tau50(50) = [ &
    & 1e-10, 5.338811891030129e-08, 8.362331884111431e-07, 4.861124614581366e-06, 1.7974488760296254e-05, &
    & 5.042204513091143e-05, 0.00011694127900448181, 0.00024219695498795706, 0.0004603372658787293, 0.0008172091391128376, &
    & 0.0013415403225375722, 0.002144340250717192, 0.00328669997066726, 0.004852969907929029, 0.006972510017641433, &
    & 0.009794584259407962, 0.013486216961696202, 0.018206074746037908, 0.024094117007338947, 0.03147560124822055, &
    & 0.041286411974107595, 0.05323270316956191, 0.0672788233511656, 0.08562489347334869, 0.10858629734203992, &
    & 0.13526542201004957, 0.17138652933972176, 0.2184682422689322, 0.2711800013740247, 0.3406695466562243, &
    & 0.42843261365659663, 0.5430882723018798, 0.7098902267813947, 0.9014001895526775, 1.1172750532460791, &
    & 1.4057315037108384, 1.7527135513372174, 2.1944091349828687, 2.7359328697015015, 3.3743436090139385, &
    & 4.147611672286494, 5.234307950546169, 6.570336198895639, 8.385244199091588, 11.04942434647717, &
    & 14.777492658663105, 20.308396218820466, 28.982394111240325, 43.92730811695769, 100.0]

  real(irealLUT), parameter :: preset_tau100(100) = [ &
    & 1e-10, 5.37728363044873e-09, 5.169049055857198e-08, 2.4598675510616015e-07, &
    & 8.039571528924054e-07, 2.098073415864625e-06, 4.667127272143388e-06, 9.324460471450704e-06, 1.7165549137844286e-05, &
    & 2.90879230657816e-05, 4.806942728054129e-05, 7.491098163928386e-05, 0.00011214198296091938, 0.00016308181329007115, &
    & 0.00023167419537611342, 0.00032252261454573776, 0.00044074003852133094, 0.00059125104599078, 0.0007770990652211666, &
    & 0.000997327115506647, 0.0012847571003086623, 0.0016366155931166531, 0.0020284269904084153, 0.0025331899464225093, &
    & 0.0031214610084221335, 0.0037783288538385186, 0.004620748847656249, 0.0054838585412371535, 0.006642257028695146, &
    & 0.007785192309098565, 0.00932259649547388, 0.010844617746035264, 0.012806526540467725, 0.014849173636356868, &
    & 0.017231900565005377, 0.019999959694720276, 0.02270634796718345, 0.0264592148651827, 0.03008669577920718, &
    & 0.034318129456378646, 0.03930034934536566, 0.04413612029203585, 0.05035250121982595, 0.057033959773244006, &
    & 0.06356597568413477, 0.0723277786751802, 0.0814213068875702, 0.09034987191047701, 0.10241153934806349, &
    & 0.11498895432001131, 0.12738757985333699, 0.14403877957393815, 0.161946923503206, 0.179748380617577, &
    & 0.2040149611810356, 0.23024802158688207, 0.2545180428537337, 0.285994708770138, 0.32055870736003567, &
    & 0.35445219856001947, 0.39742940126699644, 0.44806103870702746, 0.49951648556079753, 0.5754122153050649, &
    & 0.6597526112731152, 0.7349105199533222, 0.8333033472323181, 0.9341877898245448, 1.0312678696371371, &
    & 1.161101898077268, 1.30422934778624, 1.4444805775792111, 1.6117827570348249, 1.807133744561576, &
    & 2.0184543699056356, 2.2646480171282124, 2.5297725486144933, 2.7950757595262323, 3.07207346783699, &
    & 3.452420767251508, 3.8350241923424218, 4.218996502675129, 4.751235023624452, 5.3285345041893155, &
    & 5.910149704768436, 6.69544596601627, 7.5897869114037935, 8.498618547599737, 9.78291542300274, &
    & 11.194852811684102, 12.815624611606115, 14.954957349304067, 17.224307620770194, 20.5193734139549, &
    & 24.051638705145788, 29.207296766013734, 34.97208099057306, 44.121158150380154, 56.57995282230244, 100.0]

  real(irealLUT), parameter :: preset_w010(10) = &
                               [0.0, 0.146844960107, 0.299864348265, 0.441659869071, 0.571826424536, &
                                0.689506880372, 0.793582370219, 0.882074852633, 0.94968540101, 0.99999]

  real(irealLUT), parameter :: preset_w020(20) = &
                               [0.0, 0.152960717624, 0.295085090042, 0.416951893959, 0.521358613652, &
                                0.610087211908, 0.684967634054, 0.747886390181, 0.800286677013, &
                                0.84336972609, 0.878674797098, 0.906377786525, 0.928097831502, &
                                0.943463164595, 0.954135786554, 0.963824066888, 0.972632134967, &
                                0.981529289348, 0.990759644674, 0.99999]

  real(irealLUT), parameter :: preset_w021(21) = &
                               [0.0, 0.152960717624, 0.295085090042, 0.416951893959, 0.521358613652, &
                                0.610087211908, 0.684967634054, 0.747886390181, 0.800286677013, &
                                0.84336972609, 0.878674797098, 0.906377786525, 0.928097831502, &
                                0.943463164595, 0.954135786554, 0.963824066888, 0.972632134967, &
                                0.981529289348, 0.990759644674, 0.99999, 1.0]

  real(irealLUT), parameter :: preset_w050(50) = [ &
    & 0.0, 0.0016086046034482757, 0.034784134913793105, 0.06592520281034484, 0.09661799932758622, &
    & 0.1269056274827586, 0.1567923975775862, 0.18628089579310345, 0.21537457037068966, 0.24403980095689654, &
    & 0.27228779433620687, 0.3001142402068966, 0.32752517299137934, 0.3545274891724138, 0.38108412015517235, &
    & 0.40721403126724137, 0.4329301534137931, 0.45820490066379305, 0.4830236179913793, 0.5074061327844828, &
    & 0.531360203586207, 0.5548470376810344, 0.5778718074310344, 0.6004560643448277, 0.6225653260086207, &
    & 0.6441918338793104, 0.6653648980086206, 0.6860310706551724, 0.7061843173965517, 0.7258936030603449, &
    & 0.7450209979913792, 0.7637009836034483, 0.7817663201896552, 0.7993532132844827, 0.8162823543362069, &
    & 0.8327485689827586, 0.8483966883620688, 0.8637499831034483, 0.8778731177327586, 0.8919255634137929, &
    & 0.904050442163793, 0.9152227442327586, 0.9263976324827586, 0.937100973724138, 0.9474715596724138, &
    & 0.9578412835603448, 0.9682635931293101, 0.9788384873793103, 0.98941510575, 0.99999]

  real(irealLUT), parameter :: preset_w0100(100) = [ &
    & 0.0, 0.0012724010689655174, 0.017731719232758618, 0.03413586553448275, 0.04959864193965517, &
    & 0.06498728115517241, 0.08021126684482759, 0.0953800806724138, 0.11043682665517242, 0.12538064273275862, &
    & 0.14026239046551722, 0.15499155351724136, 0.16967502737068965, 0.18421281302586207, 0.19868077179310345, &
    & 0.21304528331896547, 0.22728393403448277, 0.24145103374137927, 0.2554905485172414, 0.26944816756034484, &
    & 0.2833066496637931, 0.29704530537931034, 0.31069085857758616, 0.32422520599137933, 0.3376604164655173, &
    & 0.35100855884482757, 0.36423084041379306, 0.3773539850431034, 0.3903805789137931, 0.40328217403448274, &
    & 0.41609583899999997, 0.4288026084827586, 0.44138868951724136, 0.4538928748189655, 0.4662720613706896, &
    & 0.478540042137931, 0.49072009274999995, 0.5027716963706896, 0.5147172665689654, 0.5265654239482759, &
    & 0.5382842722758622, 0.5499013974827586, 0.56141938575, 0.5728028926034483, 0.5840855383965516, &
    & 0.5952621507672414, 0.606313764387931, 0.617248137801724, 0.628083374275862, 0.6387763707931036, &
    & 0.6493650580086208, 0.6598589185862069, 0.6701907118189655, 0.680427678413793, 0.6905620598275862, &
    & 0.7005464427413793, 0.7104109992672414, 0.7201729706120689, 0.7298082190862067, 0.7392564004655173, &
    & 0.7486554444051724, 0.7579251792931033, 0.7670138815086207, 0.7759379301982758, 0.7848352550172413, &
    & 0.7935860295775862, 0.8020962893017242, 0.8104712055517241, 0.8188461218017241, 0.8270581086465517, &
    & 0.834970960551724, 0.8427105383275862, 0.8504509781637931, 0.8581224531724139, 0.8655008276637931, &
    & 0.8724792061551723, 0.8794334469568965, 0.8863902739396552, 0.8932755499137932, 0.8995349700775863, &
    & 0.9050650871896553, 0.910596066362069, 0.9161261834741379, 0.921656300586207, 0.9271872797586207, &
    & 0.9325967084224138, 0.937730277775862, 0.9428621230086206, 0.9479939682413793, 0.9531275375948275, &
    & 0.958260244887931, 0.9633920901206897, 0.9685842795775862, 0.9738187099913793, 0.9790531404051723, &
    & 0.9842875708189655, 0.9895211391724137, 0.9947564316465517, 0.99999, 1.]

  real(irealLUT), parameter :: preset_g2(2) = [0.0, 0.5]
  real(irealLUT), parameter :: preset_g3(3) = [0.0, 0.2670, 0.5]
  real(irealLUT), parameter :: preset_g4(4) = [0.0, 0.4, 0.65, 0.85]
  real(irealLUT), parameter :: preset_g6(6) = [0.0, 0.2424, 0.4137, 0.5717, 0.7144, 0.85]

  !-----------------------------------------
  !- Define precision of coefficients      -
  !-----------------------------------------
  ! absolute tolerance and relatice tolerance have to be reached for every
  ! coefficient

!      real(irealLUT),parameter :: stddev_atol=1e-2_irealLUT
!      real(irealLUT),parameter :: stddev_atol=5e-3_irealLUT
  real(irealLUT) :: stddev_atol = 5e-4_ireallut
!      real(irealLUT),parameter :: stddev_atol=2e-4_irealLUT
!      real(irealLUT),parameter :: stddev_atol=5e-6_irealLUT

  real(irealLUT) :: stddev_rtol = 5e-2_ireallut
!      real(irealLUT),parameter :: stddev_rtol=1e-3_irealLUT

  ! Do some sanity checks on coefficients -- only disable if you are sure
  ! what to expect.
#ifdef __RELEASE_BUILD__
  logical, parameter :: ldebug_optprop = .false.
#else
  logical, parameter :: ldebug_optprop = .true.
#endif

  ! Treat direct2diffuse radiation in a cone around solar angle as direct
  ! radiation.
!      real(irealLUT),parameter :: delta_scale_truncate=.9848_irealLUT ! .9848 = 10 degrees delta scaling
!      real(irealLUT),parameter :: delta_scale_truncate=.9962_irealLUT ! .9962 = 5 degrees delta scaling
  real(irealLUT), parameter :: delta_scale_truncate = 1.0_ireallut   !1.     = 0 degrees delta scaling
!      real(irealLUT),parameter :: delta_scale_truncate=.8660_irealLUT ! .8660 = 30 degrees delta scaling

  ! spherical correction for wedge computations,
  ! this is tuned towards earth radius and average dx = 1000m sized elements
  real(irealLUT), parameter :: wedge_sphere_radius = 6371e3_ireallut / 1000._ireallut

  real(irealLUT), parameter :: LUT_dump_interval = 3600 * 1 ! dump the LUT every 60 minutes
  real(irealLUT), parameter :: LUT_max_create_jobtime = 3600 * 3 ! after 3hrs, cancel the createLUT jobs in any case
end module
